---
title: 演练：因设备状态而缺少对象 | Microsoft Docs
description: 执行调查，查找配置错误的设备状态。 它演示如何使用图形事件列表、图形管道阶段和图形像素历史记录。
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: conceptual
ms.assetid: 1b0d2bbd-0729-4aa5-8308-70c5bf1468c5
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.technology: vs-ide-debug
ms.workload:
- multiple
ms.openlocfilehash: 8fe9a05bd1c819ae2b17f6898341efcea7e47b49
ms.sourcegitcommit: b12a38744db371d2894769ecf305585f9577792f
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/13/2021
ms.locfileid: "126736367"
---
# <a name="walkthrough-missing-objects-due-to-device-state"></a>演练：因设备状态而缺少对象
本演练演示了如何使用 [!INCLUDE[vsprvs](../../code-quality/includes/vsprvs_md.md)] 图形诊断工具调查由于设备状态配置错误而缺失的对象。

 本演练演示了如何：

- 使用“图形事件列表”  定位问题的潜在根源。

- 使用“图形管道阶段”  窗口检查 `DrawIndexed` Direct3D API 调用的影响。

- 使用“图形像素历史记录”  窗口更具体地定位问题。

- 检查设备状态以明确潜在问题或配置错误。

## <a name="scenario"></a>方案
 对象可能不会出现在三维应用程序中预计会出现的位置的一个原因是，图形设备配置错误导致对象被排除在呈现外。例如，绕序导致错误剔除三角形，或深度测试函数导致对象中所有像素被拒绝。

 在本演练所述方案中，你已到达了三维应用开发中的首个里程碑，并已准备好对其进行首次测试。 但是，当你运行该应用时，仅用户界面会被呈现到屏幕。 通过使用“图形诊断”，捕获图形日志文件的问题，以便调试该应用。 应用中的问题如下所示：

 ![修复问题前的应用程序](media/vsg_walkthru1_firstview.png "vsg_walkthru1_firstview")

 有关如何捕获图形日志中的图形问题的信息，请参阅 [Capturing Graphics Information](capturing-graphics-information.md)。

## <a name="investigation"></a>调查
 通过使用图形诊断工具，你可以加载图形日志文件以检测测试期间捕获的帧。

#### <a name="to-examine-a-frame-in-a-graphics-log"></a>检查图形日志中的帧

1. 在 [!INCLUDE[vsprvs](../../code-quality/includes/vsprvs_md.md)]中，加载包含显示缺少模型的帧的图形日志。 [!INCLUDE[vsprvs](../../code-quality/includes/vsprvs_md.md)]中将出现新的“图形诊断”选项卡。 此选项卡的顶部是所选帧的呈现目标输出。 底部是“帧列表” ，以缩略图的形式显示每个捕获的帧。

2. 在“帧列表” 中，选择演示未显示该模型的帧。 更新呈现目标以反映所选的帧。 在此方案中，图形日志选项卡如下所示：

    ![.vsglog 选项卡帧缓冲区预览和帧列表](media/vsg_walkthru1_experiment.png "vsg_walkthru1_experiment")

   选择演示问题的帧后，可以使用“图形事件列表”  进行诊断。 “图形事件列表”  包含用以呈现活动帧的各个 Direct3D API 调用，例如设置设备状态、创建和更新缓冲区、绘制在帧中显示的对象的 API 调用。 许多类型的调用（例如绘图、调度、复制或清除调用）都很有趣，因为当应用按照预期运行时通常（但不总是）在呈现目标中会有相应的变动。 绘图调用特别有趣，因为每个绘图调用都表示应用呈现的几何图形（调度调用也可呈现几何图形）。

#### <a name="to-ensure-that-draw-calls-are-being-made"></a>确保进行绘图调用

1. 打开“图形事件列表”  窗口。 在“图形诊断”  工具栏上，选择“事件列表” 。

2. 检查“图形事件列表”  中是否存在绘图调用。 若要简化此过程，请在“图形事件列表”  窗口右上角的“搜索”  框中输入“Draw”。 这将筛选列表，使其仅包含在其标题中具有的“Draw”的事件。 在此方案中，你将发现进行了多个绘图调用：

    ![显示捕获的事件的图形事件列表](media/vsg_walkthru1_.png "vsg_walkthru1_")

   确认进行绘图调用后，即可确定对应于所缺失几何图形的调用。 由于已知（在本例中）不会将缺失的对象绘制到呈现目标，但会按预期绘制场景的其余部分，因此可以使用“图形管道阶段”  窗口确定与缺失几何图形对应的绘图调用。 “图形管道阶段”  窗口显示已发送到每个绘图调用的几何图形，而不考虑其在呈现目标的效果。 当你进行绘图调用时，将更新管道阶段以显示与该调用相关联的几何图形，并且更新呈现目标输出以显示调用完成后该呈现目标的状态。

#### <a name="to-find-the-draw-call-for-the-missing-geometry"></a>查找缺失的几何图形的绘图调用

1. 打开“图形管道阶段”  窗口。 在“图形诊断”  工具栏上，选择“管道阶段” 。

2. 通过每个绘图调用移动，同时注意“图形管道阶段”  窗口。 “输入装配器”  阶段将显示原始模型数据。 “顶点着色器”  阶段将显示转换后的模型数据。 “像素着色器”  阶段将显示像素着色器输出。 “输出合并器”  阶段将显示此绘图调用和所有以前的绘图调用的合并呈现器目标。

3. 当到达对应于缺失模型的绘图调用时即停止。 在此方案中，“图形管道阶段”  窗口指示呈现几何图形，但不显示在呈现目标中：

    ![显示缺失对象的管道查看器](media/vsg_walkthru1_pipeline.png "vsg_walkthru1_pipeline")

   在确认应用程序呈现缺失几何图形并且你找到相应的绘图调用之后，可以选择应显示缺失几何图形的部分呈现目标输出，然后使用“图形像素历史记录”  窗口找出像素被排除的原因。 像素历史记录包含可能对特定像素产生了影响的每个绘图调用的列表。 “图形像素历史记录”  窗口中的每个绘图调用由一个编号标识，该编号还显示在“图形事件列表”  窗口中。 这可以帮助你确认像素应显示缺失的几何图形，并找出像素被排除的原因

#### <a name="to-determine-why-the-pixel-was-excluded"></a>确定像素被排除的原因

1. 打开“图形像素历史记录”  窗口。 在“图形诊断”  工具栏上，选择“像素历史记录” 。

2. 根据“像素着色器”  缩略图，在应包含缺失几何图形的一部分的帧缓冲区输出中选择一个像素。 在此方案中，像素着色器输出应涵盖了大部分呈现器目标；选择某个像素后，“图形像素历史记录”  窗口将如下所示：

    ![显示相关绘图调用的“像素历史记录”窗口](media/vsg_walkthru1_hist1.png "vsg_walkthru1_hist1")

3. 通过将你正在检查的绘图调用的编号（在“图形事件列表”  窗口中）与“图形像素历史记录”  窗口中的绘图调用之一相匹配，确认所选呈现器目标像素是否包含该几何图形的一部分。 如果“图形像素历史记录”  窗口中的任何一个调用与你正在检查的绘图调用均不匹配，请重复以上步骤（步骤 1 除外）直至找到匹配项。 在此方案中，匹配的绘图调用如下所示：

    ![显示片段信息的“像素历史记录”窗口](media/vsg_walkthru1_hist2.png "vsg_walkthru1_hist2")

4. 找到匹配项后，在“图形像素历史记录”  窗口中展开匹配的绘图调用并确认是否排除了该像素。 “图形像素历史记录”  窗口中的每个绘图调用都对应于一个或多个几何基元（点、线条或三角形），这些基元由于相应对象的几何图形而与该像素相交。 每个此类交点都可能影响该像素的最终颜色。 因深度测试失败而被排除的基元由一个图标表示，该图标在从左到右向下倾斜的箭头之上显示字母 Z。

5. 展开已排除的基元，以便进一步检查导致它被排除的状态。 在“输出合并器”  组中，将指针移动到“结果” 之上。 工具提示将指示排除该基元的原因。 在此方案中，检查显示该基元被排除是由于它未通过深度测试，因此未影响像素的最终颜色。

   确定几何图形是由于其基元未通过深度测试而不显示后，不难怀疑这一问题与配置错误的设备状态相关。 可以使用“图形对象表” 检查设备状态和其他 Direct3D 对象数据。

#### <a name="to-examine-device-state"></a>检查设备状态

1. 打开“图形对象表”  窗口。 在“图形诊断”  工具栏上，选择“对象表” 。

2. 在“图形对象表”  中找到“D3D10 设备” 对象，然后打开“D3D10 设备”  对象。 **中将打开一个新的“d3d10 设备”** [!INCLUDE[vsprvs](../../code-quality/includes/vsprvs_md.md)]选项卡。 若要简化操作，可以按“类型”  对“图形对象表” 进行排序。

    ![图形对象表和相关设备状态](media/vsg_walkthru1_objtable.png "vsg_walkthru1_objtable")

3. 检查“d3d10 设备”  选项卡中显示的设备状态以查明潜在问题。 由于几何图形因其基元未通过深度测试而未显示，因此你可以专注于影响深度测试的设备状态，例如深度模具。 在此方案中，“深度模具描述”  （“输出合并器状态” 之下）包含“深度函数”  成员 `D3D10_COMPARISON_GREATER`的常见值：

    ![显示深度模具信息的 D3D10 设备窗口](media/vsg_walkthru1_devicestate.png "vsg_walkthru1_devicestate")

   确定呈现问题的原因可能是配置错误的深度函数后，可以利用此信息以及你对代码的了解查找错误设置深度函数的位置，并解决此问题。 如果你不熟悉该代码，可以使用调试时收集的线索来查找问题。例如，根据此方案中的“深度模具描述”  ，你可以在代码中搜索“depth”或“GREATER”等单词。 修复代码后，重新生成并运行应用以查明呈现的问题是否已解决：

   ![修复问题后的应用程序](media/vsg_walkthru1_finalview.png "vsg_walkthru1_finalview")