---
title: 管理测试控制器和测试代理
description: 了解在首次安装测试控制器和测试代理并对其进行配置后如何管理它们。
ms.custom: SEO-VS-2020
ms.date: 09/18/2018
ms.topic: how-to
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.technology: vs-ide-test
ms.workload:
- multiple
ms.openlocfilehash: dfbd12f9e4f18da356ed69c10a8e913f492f2c2f
ms.sourcegitcommit: b12a38744db371d2894769ecf305585f9577792f
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/13/2021
ms.locfileid: "126640969"
---
# <a name="manage-test-controllers-and-test-agents"></a>管理测试控制器和测试代理

如果你需要使用 Visual Studio 远程运行测试、跨多台计算机分发测试或运行负载测试，则必须配置测试控制器、测试代理和测试设置文件。 本主题介绍如何在第一次安装并配置测试控制器和测试代理后管理它们。

[!INCLUDE [web-load-test-deprecated](includes/web-load-test-deprecated.md)]

::: moniker range="vs-2017"
如果使用 Microsoft 测试管理器在实验室环境中运行测试，可使用 Microsoft 测试管理器的“实验室中心”中的“测试控制器管理器”来管理测试控制器及其代理   。 本主题仅在使用 Visual Studio 运行测试时适用。
::: moniker-end

有关如何安装和配置测试代理和测试控制器以便在 Visual Studio 中运行测试的信息，请参阅[配置测试代理和测试控制器](../test/configure-test-agents-and-controllers-for-load-tests.md)。

若要配置和监视测试控制器和任何注册代理，你的测试项目中必须存在包含要运行的测试的测试设置文件。 打开测试设置文件，选择“角色”并从“控制器”字段的下拉列表中选择“管理测试控制器”    。

对于负载测试项目，还可从“负载测试”菜单中选择“管理测试控制器”   。

## <a name="add-a-test-agent-to-a-test-controller"></a>将测试代理添加到测试控制器中

你可能需要将一个测试代理添加到不同的测试控制器中，或者可能必须将测试代理添加到刚才安装的测试控制器中。

### <a name="to-add-a-test-agent-to-a-test-controller"></a>将测试代理添加到测试控制器中

1. 选择“开始” > “测试代理配置工具”   。

     “配置测试代理”对话框随即显示  。

    > [!NOTE]
    > 你必须已经安装了测试代理才能将其添加到测试控制器中。 有关如何安装测试代理的详细信息，请参阅[安装和配置测试代理](../test/lab-management/install-configure-test-agents.md)。

2. 将显示有关如何运行测试代理的两个选项：

   - **服务**：如果不必运行与桌面进行交互的自动测试（如编码 UI 测试，或在测试运行时创建视频录制），请在“将测试代理作为以下内容运行”下选择“服务”   。 测试代理将作为服务启动。 选择“下一步”  。

      你现在可以输入在测试代理作为服务启动时的用户详细信息。

      1. 在“用户名”中输入名称  。

      2. 在“密码”中输入密码  。

        |**重要的用户帐户信息**|
        |-|
        |- 用户帐户不支持空密码。|
        |- 如果要使用 IntelliTrace 回收器或网络仿真，则用户帐户必须是 Administrators 组的成员。|
        |- 如果代理用户名不在代理服务中，则它将尝试添加代理用户名，这需要有测试控制器权限。|
        |- 尝试使用测试控制器的用户必须位于测试控制器的 Users 帐户中，否则他们将无法针对控制器运行测试。|

   - **交互进程**：如果要运行必须与桌面进行交互的自动测试（如编码 UI 测试，或在测试运行时创建视频录制），则选择“交互进程”  。 测试代理将作为交互进程启动，而不是作为服务启动。

      在下一页上，输入在测试代理作为进程启动时的用户详细信息以及其他选项。

      1. 在“用户名”中输入名称  。

      2. 在“密码”中输入密码  。

        > [!NOTE]
        > 如果将测试代理配置为通过不是当前活动用户的另一个用户作为交互进程运行，则必须重新启动计算机，并以这另一个用户的身份登录以便能够启动代理。 此外，用户帐户不支持空密码。 如果要使用 IntelliTrace 回收器或网络仿真，则用户帐户必须是 Administrators 组的成员。

      3. 为了确保具有测试代理的计算机在重新启动之后可以运行测试，你可以设置计算机以在测试代理使用时自动登录。 选择“自动登录”  。 这会以加密形式将用户名和密码存储在注册表中。

      4. 因为屏幕保护可能会妨碍任何必须与桌面交互的自动测试，所以为了确保禁用屏幕保护，请选择“确保禁用屏幕保护”  。

        > [!WARNING]
        > 如果自动登录或禁用屏幕保护程序，则存在安全风险。 如果启用自动登录，则其他用户能够启动此计算机并能够使用自动登录的帐户。 如果禁用屏幕保护程序，则计算机可能不会提示用户通过登录来解锁计算机。 这样，任何能够实际接触到计算机的人员都可以访问该计算机。 如果在计算机上启用这些功能，则应该确保这些计算机位于安全的场所。 例如，这些计算机位于安全的实验室中。 （如果清除“确保禁用屏幕保护”，则不会启用屏幕保护。  ）

3. 若要向其他测试控制器注册此代理，请选择“向测试控制器注册”  。 键入测试控制器的名称，后跟冒号“:”以及在“向以下测试控制器注册测试代理”中使用的端口号   。 例如，键入 agent1:6901  。

    > [!NOTE]
    > 默认端口号是 6901。

4. 若要保存所做的更改，请选择“应用设置”  。 关闭“配置摘要”对话框，然后关闭“测试代理配置工具”   。

> [!WARNING]
> 如果代理当前被配置为在另一个测试控制器上运行，则必须从该控制器中移除测试代理。

## <a name="remove-a-test-agent-from-a-test-controller"></a>从测试控制器中移除测试代理

在移除测试代理之前，必须将其设置为脱机状态。

::: moniker range="vs-2017"
> [!NOTE]
> 此过程不能用于删除作为实验室环境的一部分向控制器注册的代理。 若要从控制器中删除这些代理，则必须使用 Microsoft 测试管理器删除环境。
::: moniker-end
::: moniker range=">=vs-2019"
> [!NOTE]
> 此过程不能用于删除作为实验室环境的一部分向控制器注册的代理。
::: moniker-end

### <a name="to-remove-a-test-agent-from-a-test-controller"></a>从测试控制器中移除测试代理

::: moniker range=">=vs-2019"
在 Visual Studio 2019 中，如果已在项目中注册了测试控制器，则无法删除测试代理。
::: moniker-end
如果测试控制器未向项目注册，请按以下步骤进行操作。

1. 从 Visual Studio 打开测试项目的测试设置文件，选择“角色”并从“控制器”字段的下拉列表中选择“管理测试控制器”    。

   此时将显示“管理测试控制器”对话框  。

2. 在“控制器”下拉列表中，键入安装了测试控制器的计算机的名称  。 如果你先前已经管理了特定测试控制器，则可以从列表中选择该名称。

3. 在“代理”窗格中，选择测试代理名称  。 如果代理仍处于联机状态，请选择“脱机”  。 若要删除它，请选择“删除”  。

   > [!NOTE]
   > 移除测试代理只是解除该代理与测试控制器之间的关联。 若要完全卸载测试代理，请使用测试代理计算机上“控制面板”中的“程序和功能”  。

::: moniker range="vs-2017"
如果测试控制器已向项目注册，请使用 Microsoft 测试管理器删除该代理。
::: moniker-end

## <a name="change-the-settings-for-a-test-agent"></a>更改测试代理的设置

测试代理的状态可以是以下任何一个值：

|状态|描述|
|-|-----------------|
|运行测试|运行测试|
|就绪|可用于运行测试或收集数据和诊断信息|
|脱机|不可用于运行测试或收集数据和诊断信息|
|已断开连接|测试代理未启动|

你可以使用以下过程为测试代理更改状态和其他设置。

### <a name="to-change-the-settings-of-a-test-agent"></a>更改测试代理的设置

::: moniker range="vs-2017"
> [!NOTE]
> 如果向测试控制器注册了测试代理，且测试控制器已向项目注册，请更改 Microsoft 测试管理器中的设置。
::: moniker-end

1. 若要为负载测试配置和监视测试控制器以及任何注册的代理，请选择 Visual Studio 中的“负载测试”菜单，然后选择“管理测试控制器”   。 对于任何其他测试，在 Visual Studio 中打开测试项目的测试设置文件，选择“角色”并从“控制器”字段的下拉列表中选择“管理测试控制器”    。

   此时将打开“管理测试控制器”对话框  。

1. 在测试控制器列表中，选择要更改的测试代理所属的测试控制器的名称。 如果该测试控制器未出现在列表中，请检查是否正确注册了该测试控制器。 有关更多信息，请参见以下关于如何配置测试控制器的过程。

1. （可选）在“测试代理”窗格中，选择要为其更改属性的测试代理计算机  。

1. 选择 **属性**。

1. 根据需要更改以下测试代理属性：

|测试代理属性|描述|
|-|-----------------|
|**权重**|用于在使用具有不同性能级别的测试代理时分布负载。 例如，权重为 100 的测试代理获得的负载将为权重为 50 的测试代理的两倍。|
|**IP 切换**|用于配置 IP 切换。 IP 切换使测试代理可以使用一个 IP 地址范围向服务器发送请求。 这模拟了来自不同客户端计算机的调用。<br /><br /> 如果负载测试要访问网络场，则 IP 切换很重要。 大多数负载均衡器通过使用客户端的 IP 地址在客户端与特定的 Web 服务器之间建立关联。 如果所有请求看上去都来自单个客户端，则负载平衡器不会平衡负载。 若要在 Web 场中实现较好的负载平衡，请确保请求来自某个范围内的 IP 地址。 **注意：** 你可以指定网络适配器，也可以使用“(全部未指定)”自动选择当前未使用的网络适配器  。 <br /><br /> 若要使用 IP 切换功能，则必须以该代理计算机的管理员组中的用户身份运行 Visual Studio Test Agent 服务。 此用户是在安装代理过程中选择的，但是可以通过修改服务的属性并重启该服务来进行更改。<br /><br /> 要验证 IP 交换机制是否正常工作，可在 Web 服务器上启用 IIS 日志记录功能，使用 IIS 日志记录功能来验证请求是否来自所配置的 IP 地址。|
|**特性**|可在测试代理选择中使用的名称/值对集。 例如，某个测试可能会要求某个特定的操作系统 (OS)。 可将属性添加到测试设置文件的“角色”选项卡中，它们可用于选择与属性匹配的测试代理  。 若要在多台计算机上运行测试，请在配置为运行测试的测试设置角色中创建一个属性，然后在要在该角色中使用的每个测试代理上配置一个匹配的属性。 **注意：** 此设置仅适用于注册到测试控制器（未注册到项目）的测试代理，因为这些属性只用于 Visual Studio 的测试设置中。|

测试代理权重和测试代理特性的更改会立即生效，但不会影响正在运行的测试。 IP 地址范围将在测试控制器重新启动之后生效。

（可选）若要更改测试代理的状态，请在列表中选择代理，然后从基于代理当前状态的可用选项中选择操作。

> [!NOTE]
> 如果测试代理正在作为进程运行，则可以通过在安装测试代理的计算机上运行的通知区域图标来管理测试代理的状态。 这将显示测试代理的状态。 如果代理作为使用此工具的进程运行，你可以启动、停止或重新启动代理。

## <a name="configure-a-test-controller"></a>配置测试控制器

若要配置测试控制器，必须使用“Team Test Controller 配置工具”  。 配置测试控制器时，可以向不同的项目集合注册测试控制器，或者可以从项目集合中注销测试控制器。

如果要向 Team Foundation Server 项目集合注册测试控制器，则用于测试控制器服务的帐户必须是项目集合的“项目集合测试服务帐户”组的成员，或者用于运行测试控制器配置工具的帐户必须是“项目集合管理员”。

> [!NOTE]
> 如果要从具有现有环境的项目集合中注销测试控制器，则在移动项目集合并向该移动的项目集合重新注册测试控制器时，仍会维持这些环境。

### <a name="to-configure-a-test-controller"></a>配置测试控制器

1. 若要运行该工具以随时重新配置测试控制器，请依次选择“开始” > “测试控制器配置工具”   。

     “配置测试控制器”对话框随即显示  。

2. 选择要用作测试控制器服务的登录帐户的用户。

    > [!NOTE]
    > 用户帐户不支持空密码。

4. （可选）如果不想将测试控制器用于实验室环境，而只想从 Visual Studio 中运行测试，请清除“向团队项目集合注册测试控制器”  。

5. （可选）若要针对负载测试配置测试控制器，请选择“针对负载测试配置测试控制器”  。 在“在下面的 SQL Server 实例中创建负载测试结果数据库”中键入 SQL Server 实例  。

> [!NOTE]
> 有关测试控制器的更多疑难解答信息，请参阅[安装和配置测试代理](../test/lab-management/install-configure-test-agents.md)。

## <a name="manage-your-agents-when-you-run-your-tests-with-a-test-controller"></a>使用测试控制器运行测试时管理代理

将应用程序的角色添加到 Visual Studio 的测试设置中时，你可以为每个角色添加代理属性。 这将确定哪些测试代理可用于此角色。 当您使用这些测试设置运行测试时，为测试设置选择的测试控制器将确定所需代理的可用性。 下面是在确定代理可用性时可能发生的情况：

- 对于必须运行测试的角色，没有可用的代理。 测试无法运行。 可以执行下列操作之一，然后重新运行测试：

  - 可以等待代理变为可用于此运行测试的角色。

  - 如果有任何处于脱机状态的代理可用于此角色，你可以重新启动该代理，以使其可用。

  - 你可以为该角色将具有正确代理属性的另一个代理添加到测试控制器中。

  - 你可以在测试设置中为此角色更改代理属性，以启用想要使用的其他代理。

- 对于运行诊断数据适配器的一个或多个角色，没有可用的代理。 测试可以运行，但是诊断数据适配器无法运行。 你可以在没有诊断数据适配器的情况下运行测试，也可以执行下列操作之一并重新运行测试：

  - 可以等待代理变为可供这些角色使用。

  - 如果有任何处于脱机状态的代理可用于此角色，则必须通过“测试”菜单上的“管理测试控制器”将代理的状态更改为联机   。 另外，如果代理已与控制器断开连接，则必须重新启动代理。

  - 请验证此测试运行可能需要的所有代理都没有忙于运行测试。 可以通过“测试”菜单上的“管理测试控制器”检查任何代理的状态   。

  - 你可以为该角色将具有正确代理属性的另一个代理添加到测试控制器中。

  - 你可以在测试设置中为此角色更改代理属性，以启用想要使用的其他代理。

## <a name="load-tests-from-delay-signed-assemblies"></a>延迟签名程序集中的负载测试

测试控制器和测试代理只能加载强签名的测试程序集或未签名的测试程序集。 某些测试程序集是延迟签名的程序集，因为它们需要拥有访问应用程序的生产程序集的权限。 但是，这些程序集不是强签名的程序集，因为它们仅是测试程序集，不会分发出去。 由于这些程序集会被延迟签名，导致无法加载，所以你必须在将加载这些程序集的所有计算机（包括测试控制器计算机）上为这些程序集禁用强名称验证。 要禁用延迟签名验证，请使用 sn.exe  。 可能还需要包括请求跳过其强名称验证的延迟签名程序集的公钥标记。

请使用 Sn.exe（强名称工具）禁用延迟签名验证  。

这样在运行此命令的计算机上只会禁用指定程序集的强名称验证。 执行此操作需要有足够的权限。

测试运行完成后，应使用 SN.exe 命令重新启用延迟的签名验证  。

建议通过在脚本中使用 SN.exe 命令来禁用和重新启用签名验证  。 可以在安装脚本中禁用验证，在清理脚本中重新启用验证。

## <a name="see-also"></a>请参阅

- [安装和配置测试代理](../test/lab-management/install-configure-test-agents.md)
