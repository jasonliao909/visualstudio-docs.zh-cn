---
title: CA2116:APTCA 方法应只调用 APTCA 方法
description: 程序集中具有 System.Security.AllowPartiallyTrustedCallersAttribute 特性的方法调用没有 属性的程序集中的方法。
ms.date: 11/04/2016
ms.topic: reference
f1_keywords:
- AptcaMethodsShouldOnlyCallAptcaMethods
- CA2116
helpviewer_keywords:
- AptcaMethodsShouldOnlyCallAptcaMethods
- CA2116
ms.assetid: 8b91637e-891f-4dde-857b-bf8012270ec4
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.technology: vs-ide-code-analysis
ms.workload:
- multiple
ms.openlocfilehash: 635b4c4b6b00bbda291c3e7b646f9d8bfffda22ba31b428f72da17db9eec7e9b
ms.sourcegitcommit: c72b2f603e1eb3a4157f00926df2e263831ea472
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/12/2021
ms.locfileid: "121421158"
---
# <a name="ca2116-aptca-methods-should-only-call-aptca-methods"></a>CA2116:APTCA 方法应只调用 APTCA 方法

|项|“值”|
|-|-|
|RuleId|CA2116|
|类别|Microsoft.Security|
|重大更改|重大|

## <a name="cause"></a>原因
具有 特性的程序集 <xref:System.Security.AllowPartiallyTrustedCallersAttribute?displayProperty=fullName> 中的方法在不包含 特性的程序集中调用方法。

> [!NOTE]
> 此规则已被弃用。 有关详细信息，请参阅已 [弃用的规则](fxcop-unported-deprecated-rules.md)。

## <a name="rule-description"></a>规则说明

默认情况下，具有强名称的程序集中的公共或受保护方法由完全信任的链接 [需求](/dotnet/framework/misc/link-demands) 隐式保护;只有完全受信任的调用方才能访问强名称程序集。 使用 APTCA 属性标记 (<xref:System.Security.AllowPartiallyTrustedCallersAttribute> 强) 程序集没有此保护。 属性禁用链接要求，使没有完全信任的调用方（例如从 Intranet 或 Internet 执行的代码）可以访问程序集。

如果完全受信任的程序集上存在 APTCA 属性，并且该程序集在另一个不允许部分受信任的调用方的程序集中执行代码，则存在安全漏洞。 如果 和 这两种方法满足以下条件，恶意调用方可以使用 方法绕过保护 的隐式 `M1` `M2` `M1` 完全信任链接要求 `M2` ：

- `M1` 是在具有 APTCA 属性的完全受信任的程序集中声明的公共方法。

- `M1` 调用 的 `M2` 程序集 `M1` 外部的方法。

- `M2`的程序集没有 APTCA 属性，因此，不应由或代表部分受信任的调用方执行。

部分受信任的调用方 `X` 可以调用 方法 `M1` ，从而导致 `M1` 调用 `M2` 。 由于 没有 APTCA 属性，因此其直接调用方 () 必须满足完全信任的链接要求;具有完全信任， `M2` `M1` `M1` 因此满足此检查。 安全风险是 ，因为 不参与满足保护不受信任调用方的链接 `X` `M2` 需求。 因此，具有 APTCA 属性的方法不得调用没有 特性的方法。

## <a name="how-to-fix-violations"></a>如何解决冲突
如果需要 APCTA 属性，请使用要求来保护调用完全信任程序集的方法。 所需的确切权限将取决于方法公开的功能。 如果可能，请通过要求完全信任来保护 方法，以确保基础功能不会向部分受信任的调用方公开。 如果无法这样做，请选择一组有效保护公开功能的权限。

## <a name="when-to-suppress-warnings"></a>何时禁止显示警告
若要安全地禁止显示此规则的警告，必须确保方法公开的功能不直接或间接地允许调用方访问敏感信息、操作或以破坏性方式使用的资源。

## <a name="example-1"></a>示例 1
以下示例使用两个程序集和测试应用程序来说明此规则检测到的安全漏洞。 第一个程序集没有 APTCA 属性，并且不应可供部分受信任的调用方访问 (在上一个讨论主题中 `M2` 表示) 。

:::code language="csharp" source="../snippets/csharp/VS_Snippets_CodeAnalysis/FxCop.Security.NoAptca/cs/FxCop.Security.NoAptca.cs" id="Snippet1":::

## <a name="example-2"></a>示例 2
第二个程序集是完全受信任的，并允许部分受信任的调用方 (上一个讨论主题中表示 `M1`) 。

:::code language="csharp" source="../snippets/csharp/VS_Snippets_CodeAnalysis/FxCop.Security.YesAptca/cs/FxCop.Security.YesAptca.cs" id="Snippet1":::

## <a name="example-3"></a>示例 3
上一 (中表示的测试应用程序) `X` 部分受信任。

:::code language="csharp" source="../snippets/csharp/VS_Snippets_CodeAnalysis/FxCop.Security.TestAptcaMethods/cs/FxCop.Security.TestAptcaMethods.cs" id="Snippet1":::

该示例产生下面的输出：

```txt
Demand for full trust:Request failed.
ClassRequiringFullTrust.DoWork was called.
```

## <a name="related-rules"></a>相关规则

- [CA2117:APTCA 类型应只扩展 APTCA 基类型](../code-quality/ca2117.md)

## <a name="see-also"></a>请参阅

- [安全编码准则](/dotnet/standard/security/secure-coding-guidelines)
- [通过部分受信任的代码使用库](/dotnet/framework/misc/using-libraries-from-partially-trusted-code)
- [链接需求](/dotnet/framework/misc/link-demands)
- [数据和建模](/dotnet/framework/data/index)
